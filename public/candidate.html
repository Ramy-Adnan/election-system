<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المرشح</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; } .main-container { display: flex; height: 100vh;
        background-color: #f8f9fa; 
        font-family: 'Cairo', sans-serif;
        font-size: 18px;
        } 
        .content { flex-grow: 1; overflow-y: auto; } #map { width: 100%; height: 100%; }
        .table-actions button { margin-left: 5px; } 
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-inline-end: 8px; } 
        .status-dot.online { background-color: #198754; } .status-dot.offline { background-color: #dc3545; } 
        .modal-body .form-control { text-align: right; } .nav-link { cursor: pointer; } 
        .toast-container { z-index: 1100; } .status-present { color: #198754; font-weight: bold; }
        .status-absent { color: #dc3545; font-weight: bold; } 
        .password-cell { direction: ltr; text-align: right; min-width: 150px; } 
        .password-cell i { cursor: pointer; margin-left: 8px; color: #6c757d; } 
        .password-cell i:hover { color: #343a40; }
        .report-image {
            max-width: 40px;
            height: 50px;
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.2s;
        }
        .report-image:hover {
            transform: scale(1.1);
        }

        .main-container { display: flex; height: 100vh; } 
    .content { flex-grow: 1; overflow-y: auto; } #map { width: 100%; height: 100%; }
    </style>




</head>
<body>
    <div class="toast-container position-fixed top-0 start-0 p-3"><div id="reportToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><i class="fas fa-bell me-2"></i><strong class="me-auto">تقرير جديد</strong><small>الآن</small><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body">تم استلام تقرير جديد من <strong id="toast-observer-name"></strong>.</div></div></div>
    <div class="main-container">
        <main class="content p-4">
            <div class="d-flex justify-content-between align-items-center"><h2 id="welcome-message" class="mb-4"></h2><button class="btn btn-outline-danger" onclick="window.logout()">تسجيل الخروج</button></div>
            
            <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">المراقبة الحية</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="centers-tab" data-bs-toggle="tab" data-bs-target="#centers" type="button" role="tab">المراكز الانتخابية</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="observers-tab" data-bs-toggle="tab" data-bs-target="#observers" type="button" role="tab">إدارة المراقبين</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab">إدارة الموظفين</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">الحضور والغياب</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">تحليل الموظفين</button></li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="final-reports-tab" data-bs-toggle="tab" data-bs-target="#final-reports" type="button" role="tab">التقارير النهائية</button>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel"><div class="row"><div class="col-lg-8" style="height: 80vh; position: relative;">
                   
                   
                    <div id="map"></div>
               
     <div id="map-legend" class="card" style="position: absolute; top: 430px; right: 15px; z-index: 1; padding: 10px; background-color: rgba(255, 255, 255, 0.447); width: 150px; border: 2px solid #ddd;">
    <h6 class="card-title text-center mb-2">مفتاح الخريطة</h6>
    <div class="d-flex align-items-center mb-1">
        <span style="height: 15px; width: 15px; background-color: #0d6efd; border-radius: 50%; display: inline-block; margin-left: 8px;"></span>
        <span>تتبع مباشر</span>
    </div>
    <div class="d-flex align-items-center mb-1">
        <span style="height: 15px; width: 15px; background-color: #ffc107; border-radius: 50%; display: inline-block; margin-left: 8px;"></span>
        <span>آخر تقرير دوري</span>
    </div>
    <div class="d-flex align-items-center">
        <span style="height: 15px; width: 15px; background-color: #dc3545; border-radius: 50%; display: inline-block; margin-left: 8px;"></span>
        <span>موقع المركز</span>
    </div>
</div>
                
                </div><div class="col-lg-4" style="height: 80vh; overflow-y: auto;"><h4>حالة المراقبين</h4><div id="live-observers-list" class="list-group"></div></div></div></div>
                
                <div class="tab-pane fade" id="reports" role="tabpanel"><div class="row"><div class="col-12">
                    <h3>ملخص الحضور (آخر ساعة)</h3>
                    <div class="row mb-4">
                        <div class="col-md-6"><div class="card text-center text-white bg-success mb-3"><div class="card-body"><h5 class="card-title">إجمالي الحضور</h5><p class="card-text fs-1" id="summary-present">0</p></div></div></div>
                        <div class="col-md-6"><div class="card text-center text-white bg-danger mb-3"><div class="card-body"><h5 class="card-title">إجمالي الغياب</h5><p class="card-text fs-1" id="summary-absent">0</p></div></div></div>
                    </div>
                    <h3 class="mt-4">سجل الحضور والغياب المفصل</h3>
                    <div class="card card-body mb-3">
                        <div class="row g-3">
                            <div class="col-md-3"><input type="text" id="filter-employee-name" class="form-control" placeholder="بحث باسم الموظف..."></div>
                            <div class="col-md-3"><input type="text" id="filter-observer-name" class="form-control" placeholder="بحث باسم المراقب..."></div>
                            <div class="col-md-2"><select id="filter-status" class="form-select"><option value="">كل الحالات</option><option value="present">حاضر</option><option value="absent">غائب</option></select></div>
                            <div class="col-md-2"><input type="date" id="filter-date" class="form-control"></div>
                            <div class="col-md-2"><button id="clear-filters-btn" class="btn btn-outline-secondary w-100">مسح الفلاتر</button></div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
    <tr>
        <th>اسم الموظف</th>
        <th>الحالة</th>
        <th>وقت التسجيل</th>
        <th>بواسطة المراقب</th>
        <th>المركز</th>
        <th>القضاء او الناحية</th>
        <th>الملاحظات الخاصة</th>
        <th>الملاحظات العامة</th>
    </tr>
</thead>
                            <tbody id="attendance-log-body"></tbody>
                        </table>
                    </div>
                </div></div></div>

               <div class="tab-pane fade" id="final-reports" role="tabpanel">
    <h3>التقارير النهائية المستلمة (النتيجة النهائية)</h3>
    <p class="text-muted">هنا يتم عرض جميع تقارير المحطات النهائية التي تم إرسالها من قبل المراقبين.</p>
    
    <div class="card text-center mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            التحكم بالتقرير النهائي (استقبال صور الاشرطة)
        </div>
        <div class="card-body">
            <p class="card-text">من هنا يمكنك السماح للمراقبين ببدء إرسال التقارير النهائية أو إيقافهم.</p>
            <button id="toggle-final-report-btn" class="btn btn-lg btn-success">
                <i class="fas fa-play-circle me-2"></i>بدء استقبال التقارير النهائية
            </button>
        </div>
        <div id="final-report-status-footer" class="card-footer text-muted bg-light">
            الحالة الحالية: <span id="final-report-status" class="fw-bold text-danger">متوقف</span>
        </div>
    </div>

    <div class="card text-white bg-primary mb-3 text-center shadow-sm">
        <div class="card-header fs-5">مجموع الأصوات (حسب الفلترة)</div>
        <div class="card-body">
            <h2 class="card-title" id="total-votes-summary">0</h2>
        </div>
    </div>

    <div class="card card-body mb-3 shadow-sm">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="filter-center-name" class="form-label small">بحث باسم المركز</label>
                <input type="text" id="filter-center-name" class="form-control form-control-sm" placeholder="اكتب اسم المركز...">
            </div>
            <div class="col-md-2">
                <label for="filter-district" class="form-label small">بحث بالقضاء</label>
                <input type="text" id="filter-district" class="form-control form-control-sm" placeholder="اكتب اسم القضاء...">
            </div>
            <div class="col-md-2">
                <label for="filter-final-observer" class="form-label small">بحث بالمراقب</label>
                <input type="text" id="filter-final-observer" class="form-control form-control-sm" placeholder="اكتب اسم المراقب...">
            </div>
            <div class="col-md-2">
                <label for="filter-station-status" class="form-label small">حالة المحطة</label>
                <select id="filter-station-status" class="form-select form-select-sm">
                    <option value="">الكل</option>
                    <option value="working">عاملة</option>
                    <option value="disabled">معطلة</option>
                </select>
            </div>
            <div class="col-md-3">
                <button id="clear-final-filters-btn" class="btn btn-outline-secondary w-100 btn-sm">
                    <i class="fas fa-times me-2"></i>مسح الفلاتر
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>اسم المركز</th>
                    <th>القضاء او الناحية</th>
                    <th>رقم المحطة</th>
                    <th>حالة المحطة</th>
                    <th>عدد الأصوات</th>
                    <th>بواسطة المراقب</th>
                    <th>عدد الموظفين</th>
                    <th>صورة الشريط</th>
                    <th>الملاحظات</th>
                    <th>وقت الإرسال</th>
                </tr>
            </thead>
            <tbody id="final-reports-table-body"></tbody>
        </table>
    </div>
</div>
                
                <div class="tab-pane fade" id="analytics" role="tabpanel"><div class="d-flex justify-content-between align-items-center mb-3"><h3 class="mb-0">تحليل أداء الموظفين</h3></div><div class="card card-body mb-3"><div class="row g-3"><div class="col-md-4"><input type="text" id="analytics-filter-observer" class="form-control" placeholder="بحث حسب اسم المراقب..."></div><div class="col-md-4"><input type="text" id="analytics-filter-center" class="form-control" placeholder="بحث حسب اسم المركز..."></div><div class="col-md-4"><button id="analytics-clear-filters-btn" class="btn btn-outline-secondary w-100">مسح الفلاتر</button></div></div></div><div id="employee-analytics-container" class="row"></div></div>
               
               <div class="tab-pane fade" id="observers" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>قائمة المراقبين</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#observerModal">
            <i class="fas fa-plus"></i> إضافة مراقب جديد
        </button>
    </div>
    <div class="mb-3">
        <input type="text" id="observer-search-input" class="form-control" placeholder="🔍 ابحث عن مراقب بالاسم، اسم المستخدم، الهاتف، العنوان...">
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>الاسم الكامل</th>
                    <th>اسم المستخدم</th>
                    <th>كلمة المرور</th>
                    <th>رقم الهاتف</th>
                    <th>المهنة</th>
                    <th>العنوان</th>
                    <th>المواليد</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody id="observers-table-body"></tbody>
        </table>
    </div>
    <p class="text-muted mt-2">عدد النتائج: <span id="observers-count">0</span></p>
</div>
                
                <div class="tab-pane fade" id="employees" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>قائمة الموظفين</h3>
        <button class="btn btn-primary" onclick="window.openEmployeeModal()">
            <i class="fas fa-plus"></i> إضافة موظف جديد
        </button>
    </div>
    <div class="mb-3">
        <input type="text" id="employee-search-input" class="form-control" placeholder="🔍 ابحث عن موظف بالاسم، المهنة، المراقب المسؤول...">
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>الاسم الكامل</th>
                    <th>المهنة</th>
                    <th>المراقب المسؤول</th>
                    <th>رقم الهاتف</th>
                    <th>العنوان</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody id="employees-table-body"></tbody>
        </table>
    </div>
    <p class="text-muted mt-2">عدد النتائج: <span id="employees-count">0</span></p>
</div>
    
<div class="tab-pane fade" id="centers" role="tabpanel">
    <h3 class="mb-3">قائمة المراكز الانتخابية المسجلة</h3>
    <div class="mb-3">
        <input type="text" id="center-search-input" class="form-control" placeholder="🔍 ابحث عن مركز بالاسم، المراقب المسؤول، القضاء...">
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>اسم المركز</th>
                    <th>المراقب المسؤول</th>
                    <th>القضاء او الناحية / المنطقة</th>
                    <th>عدد المحطات</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody id="centers-table-body"></tbody>
        </table>
    </div>
    <p class="text-muted mt-2">عدد النتائج: <span id="centers-count">0</span></p>
</div>
       
</main>
    </div>
    <div class="modal fade" id="observerModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
        <form id="observerForm"><div class="modal-header">
            <h5 class="modal-title" id="observerModalLabel">إضافة/تعديل مراقب</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left:0"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="observerId">
            <div class="mb-3">
                <label for="observerFullName" class="form-label">الاسم الكامل</label>
                <input type="text" class="form-control" id="observerFullName" required>
            </div>
            <div class="mb-3">
                <label for="observerUsername" class="form-label">اسم المستخدم</label>
                <input type="text" class="form-control" id="observerUsername" required>
            </div>
            <div class="mb-3">
                <label for="observerPhoneNumber" class="form-label">رقم الهاتف</label>
                <input type="tel" class="form-control" id="observerPhoneNumber">
            </div>
            <div class="mb-3">
                <label for="observerBirthDate" class="form-label">تاريخ الميلاد</label>
                <input type="date" class="form-control" id="observerBirthDate">
            </div>
            <div class="mb-3">
                <label for="observerJobTitle" class="form-label">المهنة</label>
                <input type="text" class="form-control" id="observerJobTitle">
            </div>
            <div class="mb-3">
                <label for="observerAddress" class="form-label">العنوان</label>
                <input type="text" class="form-control" id="observerAddress">
            </div>
            <div class="mb-3">
                <label for="observerPassword" class="form-label">كلمة المرور</label>
                <input type="password" class="form-control" id="observerPassword">
                <small class="form-text text-muted">اتركه فارغاً لعدم التغيير عند التعديل.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            <button type="submit" class="btn btn-primary">حفظ</button>
        </div>
    </form></div></div></div>

    <div class="modal fade" id="employeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="employeeForm">
                    <div class="modal-header"><h5 class="modal-title" id="employeeModalLabel">إضافة/تعديل موظف</h5><button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left: 0;"></button></div>
                    <div class="modal-body">
                        <input type="hidden" id="employeeId">
                        <div class="mb-3">
                            <label for="employeeObserver" class="form-label">اختر المراقب</label>
                            <select id="employeeObserver" class="form-select" required>
                                <option value="" disabled selected>-- الرجاء الاختيار --</option>
                            </select>
                        </div>
                        <div class="mb-3"><label for="employeeFullName" class="form-label">الاسم الكامل</label><input type="text" class="form-control" id="employeeFullName" required></div>
                        <div class="mb-3"><label for="employeeJobTitle" class="form-label">المهنة</label><input type="text" class="form-control" id="employeeJobTitle" required></div>
                        <div class="mb-3"><label for="employeePhoneNumber" class="form-label">رقم الهاتف</label><input type="tel" class="form-control" id="employeePhoneNumber"></div>
                        <div class="mb-3"><label for="employeeAddress" class="form-label">العنوان</label><input type="text" class="form-control" id="employeeAddress"></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary">حفظ</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">عرض صورة الشريط</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left:0"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="صورة الشريط" class="img-fluid">
                </div>
                <div class="modal-footer">
                    <a id="downloadImageBtn" href="#" class="btn btn-success" download>
                        <i class="fas fa-download me-2"></i> تحميل الصورة
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="centerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="centerForm"><div class="modal-header"><h5 class="modal-title" id="centerModalLabel">تعديل المركز الانتخابي</h5><button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left:0"></button></div><div class="modal-body"><input type="hidden" id="centerId"><div class="mb-3"><label for="centerName" class="form-label">اسم المركز</label><input type="text" class="form-control" id="centerName" required></div><div class="mb-3"><label for="centerStationCount" class="form-label">عدد المحطات</label><input type="number" class="form-control" id="centerStationCount" required></div><div class="mb-3"><label for="centerDistrict" class="form-label">القضاء</label><input type="text" class="form-control" id="centerDistrict"></div><div class="mb-3"><label for="centerArea" class="form-label">المنطقة</label><input type="text" class="form-control" id="centerArea"></div><div class="mb-3"><label for="centerLandmark" class="form-label">أقرب نقطة دالة</label><input type="text" class="form-control" id="centerLandmark"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary">حفظ التغييرات</button></div></form></div></div></div>
    <div class="modal fade" id="logDetailModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="logDetailModalLabel">السجل التفصيلي لـ: </h5><button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left:0"></button></div><div class="modal-body"><div class="table-responsive"><table class="table table-striped"><thead><tr><th>الحالة</th><th>الوقت والتاريخ</th><th>بواسطة المراقب</th><th>الملاحظات</th></tr></thead><tbody id="logDetailModalBody"></tbody></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button></div></div></div></div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="candidate.js"></script>
</body>
</html>