<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة المراقب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; } /* يمكنك تغيير الخط إذا أردت */
    </style>
</head>
<body class="bg-gray-100">

    <!-- شاشة تسجيل الدخول -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center text-gray-800">تسجيل دخول المراقب</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-700">اسم المستخدم</label>
                    <input id="username" type="text" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">كلمة المرور</label>
                    <input id="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <!-- لوحة التحكم الرئيسية (مخفية) -->
    <div id="dashboard-view" class="hidden container mx-auto p-4">
        <header class="flex justify-between items-center mb-6">
            <h1 id="welcome-message" class="text-2xl font-bold text-gray-800">أهلاً بك</h1>
            <button id="logout-button" class="px-4 py-2 text-sm font-medium text-red-600 bg-red-100 rounded-md hover:bg-red-200">تسجيل الخروج</button>
        </header>

        <!-- الأقسام الرئيسية -->
        <div class="space-y-8">
            <!-- قسم تقرير الساعة -->
            <div class="p-6 bg-white rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2">تقرير الساعة</h3>
                <div id="hourly-report-content">
                    <p class="mb-4 text-gray-600">هنا يمكنك تسجيل الحضور والغياب للموظفين كل ساعة.</p>
                    <div id="employees-checklist" class="space-y-3">
                        <!-- سيتم ملء قائمة الموظفين هنا -->
                    </div>
                    <textarea id="report-notes" class="w-full px-3 py-2 mt-4 border border-gray-300 rounded-md" placeholder="أضف ملاحظاتك هنا..."></textarea>
                    <button id="submit-hourly-report" class="w-full mt-4 px-4 py-2 font-medium text-white bg-green-600 rounded-md hover:bg-green-700">إرسال تقرير الساعة</button>
                </div>
            </div>

            <!-- أقسام أخرى يمكن إضافتها لاحقًا -->
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginView = document.getElementById('login-view');
            const dashboardView = document.getElementById('dashboard-view');
            const loginForm = document.getElementById('login-form');
            const welcomeMessage = document.getElementById('welcome-message');
            const logoutButton = document.getElementById('logout-button');
            const employeesChecklist = document.getElementById('employees-checklist');
            const submitHourlyReportBtn = document.getElementById('submit-hourly-report');
            const reportNotes = document.getElementById('report-notes');

            let observerData = null;

            // التحقق من وجود بيانات دخول محفوظة
            const checkLogin = () => {
                const storedObserver = sessionStorage.getItem('observer');
                if (storedObserver) {
                    observerData = JSON.parse(storedObserver);
                    showDashboard();
                } else {
                    showLogin();
                }
            };

            const showDashboard = async () => {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                welcomeMessage.textContent = `أهلاً بك، ${observerData.full_name}`;
                await fetchEmployees();
            };

            const showLogin = () => {
                loginView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                sessionStorage.removeItem('observer');
                observerData = null;
            };

            const fetchEmployees = async () => {
                if (!observerData) return;
                try {
                    const response = await fetch(`/api/employees/${observerData.candidate_id}`);
                    const employees = await response.json();
                    employeesChecklist.innerHTML = ''; // مسح القائمة القديمة
                    if (employees.length === 0) {
                        employeesChecklist.innerHTML = '<p class="text-center text-gray-500">لا يوجد موظفين مسجلين.</p>';
                        return;
                    }
                    employees.forEach(emp => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-end p-3 bg-gray-50 rounded-md';
                        div.innerHTML = `
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="status-${emp.id}" value="absent" class="form-radio h-5 w-5 text-red-600">
                                    <span class="mr-2 text-red-700">غائب</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="status-${emp.id}" value="present" class="form-radio h-5 w-5 text-green-600">
                                    <span class="mr-2 text-green-700">حاضر</span>
                                </label>
                            </div>
                            <span class="font-semibold text-gray-800 flex-1 text-right">${emp.full_name}</span>
                        `;
                        employeesChecklist.appendChild(div);
                    });
                } catch (error) {
                    console.error("Error fetching employees:", error);
                    alert("فشل تحميل قائمة الموظفين.");
                }
            };
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        sessionStorage.setItem('observer', JSON.stringify(data.user));
                        observerData = data.user;
                        showDashboard();
                    } else {
                        alert('اسم المستخدم أو كلمة المرور غير صحيحة.');
                    }
                } catch (error) {
                    alert('فشل الاتصال بالخادم.');
                }
            });

            logoutButton.addEventListener('click', showLogin);

            submitHourlyReportBtn.addEventListener('click', () => {
                const present_employees = [];
                const absent_employees = [];
                const inputs = employeesChecklist.querySelectorAll('input[type="radio"]:checked');
                
                inputs.forEach(input => {
                    const employeeId = input.name.split('-')[1];
                    const employeeName = document.querySelector(`input[name="status-${employeeId}"]`).closest('.flex').parentElement.querySelector('span.font-semibold').textContent;
                    if (input.value === 'present') {
                        present_employees.push(employeeName);
                    } else {
                        absent_employees.push(employeeName);
                    }
                });

                if (present_employees.length === 0 && absent_employees.length === 0) {
                    alert("الرجاء تحديد حالة موظف واحد على الأقل.");
                    return;
                }

                const socket = io();
                socket.emit('submitReport', {
                    observerId: observerData.id,
                    present_employees,
                    absent_employees,
                    notes: reportNotes.value
                });
                alert("تم إرسال التقرير بنجاح!");
                // إعادة تحميل الموظفين لمسح الاختيارات
                fetchEmployees();
                reportNotes.value = '';
            });

            checkLogin();
        });
    </script>
</body>
</html>
